{% extends 'admin/base.html.twig' %}

{% block title %}Administration des utilisateurs{% endblock %}


{% block body %}

<div class="pcoded-content">
  <div class="pcoded-inner-content">
    <div class="main-body">
      <div class="page-wrapper">
        <div class="page-body">
          {% for label, messages in app.flashes %}
            <div class="alert alert-{{ label }} background-{{ label }}">
              <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <i class="icofont icofont-close-line-circled text-white"></i>
              </button>
              {% for message in messages %}
                <p style="margin-bottom: 0px !important;">{{ message | raw }}</p>
              {% endfor %}
            </div>
          {% endfor %}
          <div class="card">
            <div class="card-header">
              <h5>Liste des utilisateurs</h5>
            </div>
            <div class="card-block table-border-style">
              {% if users %}
                <div class="table-responsive">
                  <table class="table table-striped table-bordered datatable display">
                    <thead>
                      <tr>
                        <th>Pseudo</th>
                        <th>Téléphone</th>
                        <th>Email</th>
                        <th>Note</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for user in users %}
                        <tr>
                          <td>{{ user.pseudo }}</td>
                          <td>{{ user.phone }}</td>
                          <td>{{ user.email }}</td>
                          <td>{{ user.note }}</td>
                          <td>
                            <a href="{{ path('app_admin_user_edit', {'id': user.id}) }}" class="btn btn-primary btn-sm">Modifier</a>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                Aucun utilisateur actuellement.
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="styleSelector">
    </div>
  </div>
</div>
</div>
</div>

<style>
button.swal2-confirm.btn.btn-success {
    margin-right: 10px;
}
</style>

{% endblock %}


{% block javascripts %}
  {% include 'admin/partials/datatable.html.twig' %}

  <script>

  $('.js-delete-element').click( function () {

    event.preventDefault();
    var url = this.href;

    const swalWithBootstrapButtons = Swal.mixin({
      confirmButtonClass: 'btn btn-success',
      cancelButtonClass: 'btn btn-danger',
      buttonsStyling: false,
      reverseButtons: true
    })

    swalWithBootstrapButtons.fire({
      title: 'Êtes vous sur ?',
      html: 'Attention ! Vous aller supprimer un utilisateur.',
      type: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Oui, supprimer',
      cancelButtonText: 'Non, c\'est une erreur',
    }).then((result) => {
      if (result.value) {
        location.href = url;
      }
    });
  });

  $('a[data-toggle="tooltip"]').tooltip({
    animated: 'fade',
    placement: 'top',
    html: true
  });


  $('.add-note').click(function() {
    event.preventDefault();
    var id = $(this).data('id');
    var name = $(this).data('name');
    var content = $(this).attr('data-content');
    var btn = $(this);
    if (!content) {
      content = ""; 
    }

    swal.fire({
      title: name,
      html: '<textarea name="note" id="swal-note" class="swal2-textarea" style="margin: 15px 0px; width: 100%; font-size: 14px; height: 250px;" placeholder="Ajouter une note">'+content+'</textarea><button type="button" id="confirm-button" class="btn btn-primary" style="text-align: center;">Enregistrer</button>',
      focusConfirm: false,
      showCancelButton: false,
      showConfirmButton: false,
      showCloseButton: true,
      preConfirm: () => {
        return [
          document.getElementById('swal-note').value
        ]
      }
    }).then((result) => {
      if (result.value) {
        var note = result.value[0];
        var url = '{{ path("admin_user_note", {'id': 'id'}) }}';
        url = url.replace("id", id);
        $.ajax({
          url: url,
          type:"POST",
          data:{ note: note },
          success:function() {
            if (note) {
              btn.children('i').removeClass('fal');
              btn.children('i').addClass('fas');
            } else {
              btn.children('i').removeClass('fas');
              btn.children('i').addClass('fal');
            }
            btn.removeAttr('data-content');
            btn.attr('data-content', note);
          }
        });
      }
    });
  });


  $(document).on('click', "#confirm-button", function() {
    Swal.clickConfirm();
  });


  </script>

{% endblock %}
