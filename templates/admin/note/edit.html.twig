{% extends 'admin/base.html.twig' %}

{% block title %}Edition d'une note{% endblock %}

{% form_theme form 'bootstrap_4_layout.html.twig' %}

{% block body %}

<div class="pcoded-content">
  <div class="pcoded-inner-content">
    <div class="main-body">
      <div class="page-wrapper">
        <div class="page-body">
          {% for label, messages in app.flashes %}
            <div class="alert alert-{{ label }} background-{{ label }}">
              <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <i class="icofont icofont-close-line-circled text-white"></i>
              </button>
              {% for message in messages %}
                  <p style="margin-bottom: 0px !important;">{{ message | raw }}</p>
              {% endfor %}
            </div>
          {% endfor %}
          <div class="card">
            <div class="card-header">
              <h5>Edition d'une note</h5>
            </div>
            <div class="card-block">
              {{ form_start(form) }}
              {{ form_row(form.name, { 'label': 'Nom' }) }}
              {{ form_row(form.amount, { 'label': 'Montant' }) }}
              <div class="form-group row mt-2" style="float: right; margin-right: 20px;">
                <button type="submit" class="btn btn-primary m-b-0">Enregistrer</button>
              </div>
              {{ form_end(form) }}
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h5>Historique</h5>
              <a href="{{ path('admin_transaction_new', { id: note.id }) }}" class="btn btn-out-dashed waves-effect waves-light btn-primary btn-square text-right" style="float: right; padding: 5px 10px; margin: 0px 5px;">Ajouter une transaction</a>
            </div>
            <div class="card-block table-border-style">
              {% if note.transactions.toarray %}
                <div class="table-responsive">
                  <table class="table table-striped table-bordered datatable display">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Montant</th>
                        <th>Restant</th>
                        <th>Commande</th>
                        <th>Commentaire</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% set total = 0 %}
                      {% for transaction in note.transactions %}
                          <tr>
                            <td>{{transaction.createdAt|date_fr('EEE dd MMMM yyyy')|title }} à {{transaction.createdAt|date('H') }}h{{transaction.createdAt|date('i') }}</td>
                            <td>
                              {% if transaction.amount < 0 %}
                                <span style="color:  #ff5370;">{{ transaction.amount|number_format(2, ',', ' ') }}€</span>
                               </td>
                              {% else %}
                                <span style="color:  #2ed8b6;">{{ transaction.amount|number_format(2, ',', ' ') }}€</span>
                               </td>
                              {% endif %}
                            </td>
                            <td>
                              {% if loop.first %}
                                {% set total = total + transaction.amount %}
                                {% if transaction.amount < 0 %}
                                  <span style="color:  #ff5370;">{{ transaction.amount|number_format(2, ',', ' ') }}€</span>
                                 </td>
                                {% else %}
                                  <span style="color:  #2ed8b6;">{{ transaction.amount|number_format(2, ',', ' ') }}€</span>
                                 </td>
                                {% endif %}
                              {% elseif transaction.invoice %}
                                {% set remaining = transaction.invoice.total - transaction.invoice.paid %}
                                {% set total = total + remaining %}
                                <span style="{% if remaining > 0 %} color:  #2ed8b6; {% endif %}">{{ remaining|number_format(2, ',', ' ') }}€</span>
                               </td>
                               {% elseif transaction.amount > 0 %}
                                {% set total = total + transaction.amount %}
                                <span style="{% if transaction.amount > 0 %} color:  #2ed8b6; {% endif %}">{{ transaction.amount|number_format(2, ',', ' ') }}€</span>
                              {% endif %}
                            <td>
                              {% if transaction.invoice %}
                                <a href="{{ path('admin_order_edit', { id : transaction.invoice.id }) }}" style="color: #007bff;" target="blank">N°{{transaction.invoice.id }}</a>
                              {% endif %}
                            </td>
                            <td>{{transaction.comment }}</td>
                            <td>
                              {% if not loop.first %}
                                {% if transaction.invoice %}
                                  <a href="{{ path('admin_order_export', {id: transaction.invoice.id }) }}" target="_blank">
                                    <i class="fas fa-download" style="color: #7f8c8d; font-size: 20px; padding: 3px;"></i>
                                  </a>
                                {% endif %}
                                <a href="{{ path('admin_transaction_delete', { id : transaction.id }) }}" class="js-delete">
                                  <i class="fas fa-trash" style="color: #ff5370; font-size: 20px; padding: 3px;"></i>
                                </a>
                              {% endif %}
                            </td>
                          </tr>
                      {% endfor %}
                      <tr>
                        <td><span style="font-weight: bold;">Total</span></td>
                        <td></td>
                        <td>
                          {% if total < 0 %}
                            <span style="color:  #ff5370;font-weight: bold;">{{ total|number_format(2, ',', ' ') }}€</span>
                           </td>
                          {% else %}
                            <span style="color:  #2ed8b6;font-weight: bold;">{{ total|number_format(2, ',', ' ') }}€</span>
                           </td>
                          {% endif %}
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              {% else %}
                Aucune transaction.
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="styleSelector">
    </div>
  </div>
</div>
</div>
</div>

<script>
  $('#admin_note_amount').parent().hide();
</script>




{% endblock %}

{% block javascripts %}

<script>
  
$('.js-delete').click( function () {
  event.preventDefault();
  var url = this.href;

  const swalWithBootstrapButtons = Swal.mixin({
    confirmButtonClass: 'btn btn-success',
    cancelButtonClass: 'btn btn-danger',
    buttonsStyling: false,
    reverseButtons: true
  })

  swalWithBootstrapButtons.fire({
    title: 'Êtes vous sur ?',
    html: 'Attention ! Vous aller supprimer une transaction.',
    type: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Oui, supprimer',
    cancelButtonText: 'Non, c\'est une erreur',
  }).then((result) => {
    if (result.value) {
      location.href = url;
    }
  });
});

</script>

{% endblock %}


